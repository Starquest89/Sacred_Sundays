
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weekly Efficiency ‚Äî Sacred Sundays</title>
  <meta name="color-scheme" content="light dark" />

  <!-- Chart.js + DataLabels plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <style>
    :root{
      --max-width:1100px;

      /* LIGHT THEME ‚Äî green accent */
      --bg:#e4f3ea;
      --bg-radial-top:#ecfdf3;
      --bg-radial-bottom:#dcfce7;
      --card-bg:#ffffff;
      --card-border:#e5e7eb;
      --text-main:#0f172a;
      --text-subtle:#6b7280;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,0.12);
      --accent-strong:rgba(34,197,94,0.28);
      --pill-bg:#f9fafb;
      --pill-border:#d1d5db;
      --pill-text:#111827;
      --pill-active-bg:#22c55e;
      --pill-active-text:#ffffff;
      --shadow-soft:0 18px 40px rgba(15,23,42,0.16);
      --divider:rgba(148,163,184,0.55);
      --chip-bg:#f9fafb;
      --chip-border:#e5e7eb;
      --chip-text:#4b5563;
      --danger:#b91c1c;
      --success:#047857;
      --warning:#a16207;
    }

    body.dark{
      --bg:#020617;
      --bg-radial-top:#022c22;
      --bg-radial-bottom:#020617;
      --card-bg:#020617;
      --card-border:#1f2937;
      --text-main:#e5e7eb;
      --text-subtle:#9ca3af;
      --accent:#4ade80;
      --accent-soft:rgba(74,222,128,0.22);
      --accent-strong:rgba(74,222,128,0.38);
      --pill-bg:#020617;
      --pill-border:#4b5563;
      --pill-text:#e5e7eb;
      --pill-active-bg:#4ade80;
      --pill-active-text:#022c22;
      --shadow-soft:0 18px 40px rgba(0,0,0,0.9);
      --divider:rgba(55,65,81,0.95);
      --chip-bg:#020617;
      --chip-border:#4b5563;
      --chip-text:#e5e7eb;
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      min-height:100vh;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text",
        "Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 0 0,var(--bg-radial-top),transparent 55%),
        radial-gradient(circle at 100% 0,var(--bg-radial-bottom),transparent 55%),
        var(--bg);
      color:var(--text-main);
      display:flex;
      justify-content:center;
    }

    .page{
      width:100%;
      max-width:var(--max-width);
      padding:18px 14px 30px;
      position:relative;
    }

    @media(min-width:768px){
      .page{padding:26px 18px 40px;}
    }

    /******** HEADER + NAV PILLS ********/
    .page-header{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-bottom:16px;
    }

    .title-row{
      display:flex;
      align-items:center;
      gap:8px;
    }

    .title-icon{
      width:28px;
      height:28px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:var(--accent-soft);
      font-size:17px;
    }

    .title-text{
      font-weight:700;
      font-size:1.15rem;
      letter-spacing:0.08em;
      text-transform:uppercase;
    }

    .nav-pills{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    .nav-pill{
      flex:1 1 calc(50% - 6px);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:7px 8px;
      border-radius:14px;
      border:1px dashed var(--pill-border);
      background:var(--pill-bg);
      color:var(--pill-text);
      font-size:0.78rem;
      letter-spacing:0.11em;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
      transition:background 0.18s,border-color 0.18s,transform 0.12s;
    }

    .nav-pill span.emoji{
      font-size:1.05rem;
    }

    .nav-pill:active{
      transform:scale(0.97);
    }

    .nav-pill.dark-active{
      background:var(--pill-active-bg);
      color:var(--pill-active-text);
      border-style:solid;
      border-color:var(--pill-active-bg);
    }

    /******** ALL TEAMS DROPDOWN ********/
    .team-dropdown{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      top:80px;
      z-index:20;
      display:none;
    }

    .team-dropdown.open{display:block;}

    .team-dropdown-card{
      max-width:420px;
      max-height:320px;
      overflow-y:auto;
      padding:10px 10px 8px;
      border-radius:18px;
      border:1px solid var(--card-border);
      background:var(--card-bg);
      box-shadow:var(--shadow-soft);
      backdrop-filter:blur(14px);
    }

    .team-dropdown-title{
      font-size:0.75rem;
      text-transform:uppercase;
      letter-spacing:0.16em;
      color:var(--text-subtle);
      margin-bottom:6px;
    }

    .team-dd-item{
      width:100%;
      text-align:left;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid transparent;
      background:transparent;
      color:var(--text-main);
      font-size:0.8rem;
      display:flex;
      gap:6px;
      cursor:pointer;
      transition:background 0.14s,border-color 0.14s,transform 0.08s;
    }

    .team-dd-item.active{
      background:var(--accent-soft);
      border-color:var(--accent-strong);
    }

    .team-dd-item:active{
      transform:scale(0.98);
    }

    main{
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .teams-container{
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .card{
      background:radial-gradient(circle at 0 0,var(--accent-soft),transparent 65%),
        var(--card-bg);
      border-radius:22px;
      border:1px solid var(--card-border);
      box-shadow:var(--shadow-soft);
      padding:14px 14px 16px;
      backdrop-filter:blur(18px);
    }

    .mgr-heading-row{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom:10px;
    }

    .mgr-ident{
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .mgr-team{
      font-size:1.05rem;
      font-weight:700;
    }

    .mgr-owner{
      font-size:0.8rem;
      color:var(--text-subtle);
    }

    /******** SUMMARY PILL (3-row layout) ********/
    .mgr-summary-pill{
      border-radius:18px;
      background:var(--card-bg);
      border:1px solid var(--card-border);
      padding:10px 10px 8px;
      display:grid;
      grid-template-columns:1.4fr 0.8fr;
      grid-auto-rows:auto;
      column-gap:10px;
      row-gap:2px;
    }

    .summary-top-label{
      font-size:0.68rem;
      text-transform:uppercase;
      letter-spacing:0.14em;
      color:var(--text-subtle);
    }

    .summary-top-label.right{
      text-align:right;
      white-space:nowrap;
    }

    .summary-main-left{
      font-weight:700;
      font-size:1.35rem;
    }

    .summary-main-right{
      font-weight:700;
      font-size:1.1rem;
      text-align:right;
    }

    .summary-sub-label{
      font-size:0.68rem;
      text-transform:uppercase;
      letter-spacing:0.12em;
      color:var(--text-subtle);
      margin-top:4px;
    }

    .summary-sub-label.right{
      text-align:right;
    }

    .summary-sub-value{
      font-size:0.74rem;
      color:var(--text-subtle);
    }

    .summary-sub-value.right{
      text-align:right;
    }

    .divider{
      height:1px;
      margin:10px 0 12px;
      background:linear-gradient(to right,transparent,var(--divider),transparent);
    }

    /******** CHART AREA ********/
    .card-section-title{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
    }

    .card-section-title span.label{
      font-size:0.75rem;
      text-transform:uppercase;
      letter-spacing:0.18em;
      color:var(--text-subtle);
    }

    .chart-legend{
      font-size:0.7rem;
      color:var(--text-subtle);
    }

    .legend-item{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--chip-border);
      background:var(--chip-bg);
    }

    .legend-box{
      width:9px;
      height:9px;
      border-radius:3px;
      border:2px solid var(--accent);
      background:transparent;
    }

    .chart-filters{
      display:flex;
      gap:6px;
      margin-bottom:6px;
    }

    .chart-pill{
      padding:3px 9px;
      border-radius:999px;
      border:1px solid var(--pill-border);
      background:var(--pill-bg);
      color:var(--pill-text);
      font-size:0.7rem;
      text-transform:uppercase;
      letter-spacing:0.14em;
      cursor:pointer;
      white-space:nowrap;
      transition:background 0.18s,border-color 0.18s,transform 0.08s;
    }

    .chart-pill.active{
      background:var(--pill-active-bg);
      color:var(--pill-active-text);
      border-color:var(--pill-active-bg);
    }

    .chart-pill:active{
      transform:scale(0.97);
    }

    .chart-container{
      position:relative;
      width:100%;
      height:260px;
    }
    @media(min-width:768px){
      .chart-container{height:300px;}
    }

    .chart-meta{
      margin-top:6px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:0.74rem;
      color:var(--text-subtle);
    }

    .chart-meta span.tag{
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--chip-border);
      background:var(--chip-bg);
      color:var(--chip-text);
    }

    /******** WEEK DETAIL FLIP CARD ********/
    .flip-card{
      margin-top:10px;
      perspective:1100px;
    }

    .flip-inner{
      position:relative;
      transform-style:preserve-3d;
      transition:transform 0.55s cubic-bezier(0.19,1,0.22,1);
    }

    .flip-card.flipped .flip-inner{
      transform:rotateY(180deg);
    }

    .flip-face{
      position:relative;
      backface-visibility:hidden;
    }

    .flip-back{
      position:absolute;
      inset:0;
      transform:rotateY(180deg);
    }

    .week-card{
      background:radial-gradient(circle at 100% 0,var(--accent-soft),transparent 75%),
        var(--card-bg);
      border-radius:18px;
      border:1px solid var(--card-border);
      box-shadow:var(--shadow-soft);
      padding:12px 12px 13px;
      min-height:190px;
      font-size:0.78rem;
    }

    .wk-label{
      font-size:0.72rem;
      text-transform:uppercase;
      letter-spacing:0.16em;
      color:var(--text-subtle);
      margin-bottom:2px;
    }

    .wk-title-row{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:8px;
      margin-bottom:6px;
    }

    .wk-team{
      font-weight:600;
      font-size:0.92rem;
    }

    .wk-owner{
      font-size:0.75rem;
      color:var(--text-subtle);
    }

    .wk-eff-pill{
      padding:3px 9px;
      border-radius:999px;
      border:1px solid var(--accent-strong);
      background:var(--accent-soft);
      color:var(--accent);
      font-size:0.72rem;
      display:inline-flex;
      align-items:center;
      gap:5px;
    }

    .wk-eff-pill strong{
      font-size:0.86rem;
    }

    .wk-stat-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:7px;
      margin-top:6px;
    }

    .wk-stat-box{
      padding:5px 7px;
      border-radius:10px;
      border:1px solid var(--chip-border);
      background:var(--chip-bg);
    }

    .wk-stat-label{
      font-size:0.65rem;
      text-transform:uppercase;
      letter-spacing:0.16em;
      color:var(--text-subtle);
      margin-bottom:2px;
    }

    .wk-stat-val{
      font-weight:600;
    }

    .wk-bench{
      margin-top:8px;
      padding-top:6px;
      border-top:1px dashed var(--divider);
    }

    .wk-bench-title{
      font-size:0.66rem;
      text-transform:uppercase;
      letter-spacing:0.16em;
      color:var(--text-subtle);
      margin-bottom:3px;
    }

    .wk-bench-body{
      max-height:70px;
      overflow-y:auto;
      line-height:1.35;
    }

    .wk-outcomes{
      margin-top:7px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }

    .wk-tag{
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--chip-border);
      background:var(--chip-bg);
      color:var(--chip-text);
      font-size:0.72rem;
    }

    .wk-tag.success{
      border-color:var(--success);
      color:var(--success);
    }
    .wk-tag.danger{
      border-color:var(--danger);
      color:var(--danger);
    }
    .wk-tag.warning{
      border-color:var(--warning);
      color:var(--warning);
    }

    .empty-state{
      font-size:0.8rem;
      color:var(--text-subtle);
      text-align:center;
      padding:16px 6px;
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="page-header">
      <div class="title-row">
        <div class="title-icon">üìà</div>
        <div class="title-text">Weekly Efficiency</div>
      </div>
      <div class="nav-pills">
        <button class="nav-pill" id="btnHome" type="button">
          <span class="emoji">üè†</span><span>Home</span>
        </button>
        <button class="nav-pill" id="btnReset" type="button">
          <span class="emoji">üîÑ</span><span>Reset Page</span>
        </button>
        <button class="nav-pill" id="btnDarkMode" type="button">
          <span class="emoji">üåô</span><span>Dark Mode</span>
        </button>
        <button class="nav-pill" id="btnAllTeams" type="button">
          <span class="emoji">üìã</span><span id="allTeamsLabel">All Teams</span>
        </button>
      </div>
    </header>

    <!-- Dropdown: All Teams / individual teams -->
    <div class="team-dropdown" id="teamDropdown">
      <div class="team-dropdown-card">
        <div class="team-dropdown-title">Teams</div>
        <div id="teamDropdownList"></div>
      </div>
    </div>

    <main>
      <div class="teams-container" id="teamsContainer">
        <!-- team cards injected by JS -->
      </div>
    </main>
  </div>

  <script>
    // Register datalabels plugin if present
    if (window.ChartDataLabels) {
      Chart.register(ChartDataLabels);
    }

    // Custom plugin to draw boxes around X-axis labels for abandoned wins
    const AbandonedWinsPlugin = {
      id: "abandonedWins",
      afterDraw(chart, args, opts) {
        const xAxis = chart.scales.x;
        if (!xAxis) return;
        const ds = chart.data.datasets[0];
        if (!ds || !ds.abandoned) return;
        const abandoned = ds.abandoned;
        const ctx = chart.ctx;
        const ticks = xAxis.ticks || [];
        if (!ticks.length) return;

        const styles = getComputedStyle(document.body);
        const accent = styles.getPropertyValue("--accent").trim() || "#22c55e";

        ctx.save();
        ctx.strokeStyle = accent;
        ctx.lineWidth = 1.3;

        const paddingX = 4;
        const paddingY = 2;
        const rectHeight = 14;

        ticks.forEach((tick, index) => {
          if (!abandoned[index]) return;
          const label = tick.label;
          if (label == null) return;

          const x = xAxis.getPixelForTick(index);
          const textWidth = ctx.measureText(label).width;
          const rectWidth = textWidth + paddingX * 2;
          const left = x - rectWidth / 2;
          const top = xAxis.bottom + 2;

          const r = 4;
          ctx.beginPath();
          ctx.moveTo(left + r, top);
          ctx.lineTo(left + rectWidth - r, top);
          ctx.quadraticCurveTo(left + rectWidth, top, left + rectWidth, top + r);
          ctx.lineTo(left + rectWidth, top + rectHeight - r);
          ctx.quadraticCurveTo(left + rectWidth, top + rectHeight, left + rectWidth - r, top + rectHeight);
          ctx.lineTo(left + r, top + rectHeight);
          ctx.quadraticCurveTo(left, top + rectHeight, left, top + rectHeight - r);
          ctx.lineTo(left, top + r);
          ctx.quadraticCurveTo(left, top, left + r, top);
          ctx.stroke();
        });

        ctx.restore();
      }
    };

    Chart.register(AbandonedWinsPlugin);

    /******** CONFIG: SHEET CSV URL ********/
    const SHEET_CSV_URL =
      "https://docs.google.com/spreadsheets/d/1vNjLCTxmM1c09aONXyQYpGTPwcGG-hmnflq8-ZC3Rmo/export?format=csv&gid=465215196";

    const DARK_KEY = "sacredSundaysDark";

    const els = {
      btnHome: document.getElementById("btnHome"),
      btnReset: document.getElementById("btnReset"),
      btnDarkMode: document.getElementById("btnDarkMode"),
      btnAllTeams: document.getElementById("btnAllTeams"),
      allTeamsLabel: document.getElementById("allTeamsLabel"),
      teamDropdown: document.getElementById("teamDropdown"),
      teamDropdownList: document.getElementById("teamDropdownList"),
      teamsContainer: document.getElementById("teamsContainer")
    };

    let teamsByName = new Map();
    let teamList = [];
    let selectedFilterTeam = null; // null = All Teams
    let leagueEff = 0; // league average efficiency (0‚Äì1)

    /******** DARK MODE ********/
    function applyInitialDarkMode(){
      const stored = localStorage.getItem(DARK_KEY);
      const prefersDark = window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;
      const shouldDark = stored === "1" || (stored === null && prefersDark);
      if(shouldDark){
        document.body.classList.add("dark");
        els.btnDarkMode.classList.add("dark-active");
      }
    }

    function toggleDark(){
      document.body.classList.toggle("dark");
      const isDark = document.body.classList.contains("dark");
      els.btnDarkMode.classList.toggle("dark-active", isDark);
      localStorage.setItem(DARK_KEY, isDark ? "1" : "0");
      // Update all charts for new theme
      teamList.forEach(t => {
        if(t.chart){
          applyChartTheme(t.chart);
          t.chart.update();
        }
      });
    }

    /******** NAV EVENTS ********/
    els.btnHome.addEventListener("click", () => {
      window.location.href = "index.html";
    });

    els.btnReset.addEventListener("click", () => {
      selectedFilterTeam = null;
      els.allTeamsLabel.textContent = "All Teams";
      updateTeamVisibility();
      teamList.forEach(t => resetWeekCard(t));
      window.scrollTo({top:0,behavior:"smooth"});
    });

    els.btnDarkMode.addEventListener("click", toggleDark);

    els.btnAllTeams.addEventListener("click", () => {
      els.teamDropdown.classList.toggle("open");
    });

    document.addEventListener("click", (e) => {
      if(e.target === els.btnAllTeams || els.btnAllTeams.contains(e.target)) return;
      if(els.teamDropdown.contains(e.target)) return;
      els.teamDropdown.classList.remove("open");
    });

    /******** HELPERS ********/
    function slugify(str){
      return str.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");
    }

    function parseCsv(text){
      const lines = text.replace(/\r\n/g,"\n").split("\n").filter(x => x.trim().length);
      if(!lines.length) return {header:[],rows:[]};

      function splitLine(line){
        const out = [];
        let field = "";
        let inQuotes = false;
        for(let i=0;i<line.length;i++){
          const ch = line[i];
          if(ch === '"'){
            if(inQuotes && line[i+1] === '"'){
              field += '"'; i++;
            } else {
              inQuotes = !inQuotes;
            }
          } else if(ch === "," && !inQuotes){
            out.push(field);
            field = "";
          } else {
            field += ch;
          }
        }
        out.push(field);
        return out.map(s => s.trim());
      }

      const header = splitLine(lines[0]);
      const rows = lines.slice(1).map(splitLine);
      return {header,rows};
    }

    /******** DATA LOAD ********/
    async function loadData(){
      try{
        const res = await fetch(SHEET_CSV_URL);
        if(!res.ok) throw new Error("HTTP "+res.status);
        const text = await res.text();
        const {header,rows} = parseCsv(text);

        if(!rows.length) throw new Error("No rows in CSV");

        const idx = n => header.indexOf(n);

        const cWeek   = idx("Week");
        const cTeam   = idx("Team");
        const cOwner  = idx("Owner");
        const cProj   = idx("Projected Points");
        const cActual = idx("Actual Points");
        const cOpt    = idx("Optimal Points");
        const cWaste  = idx("Wasted Points");
        const cBench  = idx("Bench Upgrades");
        const cActRes = idx("Actual Result");
        const cOptRes = idx("Optimal Result");
        const cOutcome= idx("Outcome Change");

        const map = new Map();

        rows.forEach(r => {
          const team  = r[cTeam]  || "";
          const owner = r[cOwner] || "";
          if(!team || !owner) return;

          const week   = parseInt(r[cWeek],10);
          if(!week) return;

          const proj   = parseFloat(r[cProj]   || "0");
          const actual = parseFloat(r[cActual] || "0");
          const optimal= parseFloat(r[cOpt]    || "0");
          const wasted = parseFloat(r[cWaste]  || "0");
          const bench  = r[cBench]            || "";
          const actRes = r[cActRes]           || "";
          const optRes = r[cOptRes]           || "";
          const outcome= r[cOutcome]          || "";

          let obj = map.get(team);
          if(!obj){
            obj = {
              team,
              owner,
              slug: slugify(team),
              weeks:[],
              totalActual:0,
              totalOptimal:0,
              winsAbandoned:0,
              eff:0,
              rank:0,
              chart:null,
              range:"reg",
              flipSide:"front"
            };
            map.set(team,obj);
          }

          const eff = optimal>0 ? (actual/optimal) : 0;

          obj.weeks.push({
            week,
            proj,
            actual,
            optimal,
            eff,
            wasted,
            bench,
            actRes,
            optRes,
            outcome
          });

          obj.totalActual  += actual;
          obj.totalOptimal += optimal;
          if(outcome === "Would Have Won") obj.winsAbandoned++;
        });

        const list = Array.from(map.values());
        let leagueTotalActual = 0;
        let leagueTotalOptimal = 0;

        list.forEach(t => {
          t.eff = t.totalOptimal>0 ? (t.totalActual/t.totalOptimal) : 0;
          t.weeks.sort((a,b) => a.week-b.week);
          leagueTotalActual  += t.totalActual;
          leagueTotalOptimal += t.totalOptimal;
        });

        leagueEff = leagueTotalOptimal>0 ? (leagueTotalActual/leagueTotalOptimal) : 0;

        list.sort((a,b) => b.eff-a.eff);
        list.forEach((t,i) => {t.rank = i+1;});

        teamsByName = new Map(list.map(t => [t.team,t]));
        teamList = list;

        renderTeams();
        buildTeamDropdown();

      }catch(err){
        console.error(err);
        els.teamsContainer.innerHTML =
          '<div class="empty-state">Unable to load Weekly Efficiency data. Check sheet sharing/publishing settings.</div>';
      }
    }

    /******** RENDER TEAM CARDS ********/
    function renderTeams(){
      const parts = [];
      teamList.forEach(t => {
        const slug = t.slug;
        const effPct = (t.eff*100).toFixed(1);
        const leaguePct = (leagueEff*100).toFixed(1);
        const winsText = t.winsAbandoned === 1
          ? "1 Win Abandoned"
          : `${t.winsAbandoned} Wins Abandoned`;

        parts.push(`
          <section class="team-block" data-team="${t.team}">
            <article class="card">
              <div class="mgr-heading-row">
                <div class="mgr-ident">
                  <div class="mgr-team">${t.team}</div>
                  <div class="mgr-owner">Owner: ${t.owner}</div>
                </div>
              </div>

              <div class="mgr-summary-pill">
                <div class="summary-top-label">YTD Efficiency %</div>
                <div class="summary-top-label right">League Avg %</div>

                <div class="summary-main-left" id="summaryEffPct-${slug}">${effPct}%</div>
                <div class="summary-main-right" id="summaryLeague-${slug}">${leaguePct}%</div>

                <div class="summary-sub-label">Actual Pts</div>
                <div class="summary-sub-label right">Eff % Rank</div>

                <div class="summary-sub-value" id="summaryActual-${slug}">
                  ${t.totalActual.toFixed(2)}
                </div>
                <div class="summary-sub-value right" id="summaryRank-${slug}">
                  ${t.rank}
                </div>

                <div class="summary-sub-label">Optimal Pts</div>
                <div class="summary-sub-label right">Wins Abandoned</div>

                <div class="summary-sub-value" id="summaryOptimal-${slug}">
                  ${t.totalOptimal.toFixed(2)}
                </div>
                <div class="summary-sub-value right" id="summaryWins-${slug}">
                  ${winsText}
                </div>
              </div>

              <div class="divider"></div>

              <div class="card-section-title">
                <span class="label">Efficiency by Week</span>
                <div class="chart-legend">
                  <span class="legend-item">
                    <span class="legend-box"></span>
                    <span>Abandoned Wins</span>
                  </span>
                </div>
              </div>

              <div class="chart-filters" data-team="${slug}">
                <button class="chart-pill active" data-team="${slug}" data-range="reg">Reg Season</button>
                <button class="chart-pill" data-team="${slug}" data-range="playoffs">Playoffs</button>
              </div>

              <div class="chart-container">
                <canvas id="effChart-${slug}"></canvas>
              </div>

              <div class="chart-meta">
                <span class="tag">Tap a week to see details</span>
              </div>

              <div class="flip-card" id="weekFlip-${slug}">
                <div class="flip-inner">
                  <div class="flip-face">
                    <div class="week-card" id="wkFront-${slug}">
                      <div class="empty-state">
                        Tap any point on the chart to view that week‚Äôs efficiency breakdown.
                      </div>
                    </div>
                  </div>
                  <div class="flip-face flip-back">
                    <div class="week-card" id="wkBack-${slug}"></div>
                  </div>
                </div>
              </div>
            </article>
          </section>
        `);
      });

      els.teamsContainer.innerHTML = parts.join("");

      teamList.forEach(t => {
        setupTeamCard(t);
      });

      updateTeamVisibility();
    }

    function setupTeamCard(t){
      const slug = t.slug;
      t.range = "reg";
      t.flipSide = "front";

      const filterContainer = document.querySelector(`.chart-filters[data-team="${slug}"]`);
      const pills = filterContainer.querySelectorAll(".chart-pill");
      pills.forEach(p => {
        p.addEventListener("click", () => {
          const range = p.dataset.range;
          if(range === t.range) return;
          t.range = range;
          pills.forEach(x => x.classList.toggle("active", x.dataset.range === range));
          rebuildChartForTeam(t);
        });
      });

      rebuildChartForTeam(t);
    }

    /******** TEAM DROPDOWN ********/
    function buildTeamDropdown(){
      const listEl = els.teamDropdownList;
      listEl.innerHTML = "";

      const allBtn = document.createElement("button");
      allBtn.type = "button";
      allBtn.className = "team-dd-item";
      allBtn.dataset.team = "";
      allBtn.textContent = "All Teams";
      allBtn.addEventListener("click", () => {
        selectedFilterTeam = null;
        els.allTeamsLabel.textContent = "All Teams";
        updateTeamVisibility();
        els.teamDropdown.classList.remove("open");
      });
      listEl.appendChild(allBtn);

      teamList.forEach(t => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "team-dd-item";
        btn.dataset.team = t.team;
        btn.textContent = t.team;
        btn.addEventListener("click", () => {
          selectedFilterTeam = t.team;
          els.allTeamsLabel.textContent = t.team;
          updateTeamVisibility();
          els.teamDropdown.classList.remove("open");
        });
        listEl.appendChild(btn);
      });

      highlightDropdown();
    }

    function highlightDropdown(){
      const items = els.teamDropdownList.querySelectorAll(".team-dd-item");
      items.forEach(el => {
        const team = el.dataset.team || "";
        const isActive = (!selectedFilterTeam && team === "") ||
                         (selectedFilterTeam && team === selectedFilterTeam);
        el.classList.toggle("active", isActive);
      });
    }

    function updateTeamVisibility(){
      document.querySelectorAll(".team-block").forEach(b => {
        const team = b.getAttribute("data-team");
        const visible = !selectedFilterTeam || selectedFilterTeam === team;
        b.style.display = visible ? "" : "none";
      });
      highlightDropdown();
    }

    /******** CHART BUILDING ********/
    function getRangeData(t){
      const weeks = t.weeks.filter(w =>
        t.range === "reg" ? (w.week >=1 && w.week <=14) : (w.week >=15 && w.week <=17)
      );
      const labels = weeks.map(w => "W"+w.week);
      const data   = weeks.map(w => (w.eff || 0)*100);
      const abandoned = weeks.map(w => w.outcome === "Would Have Won");
      return {weeks,labels,data,abandoned};
    }

    function applyChartTheme(chart){
      const styles = getComputedStyle(document.body);
      const textColor = styles.getPropertyValue("--text-subtle").trim() || "#6b7280";
      const gridColor = styles.getPropertyValue("--card-border").trim() || "#e5e7eb";
      const accent    = styles.getPropertyValue("--accent").trim() || "#22c55e";

      chart.options.scales.x.ticks.color = textColor;
      chart.options.scales.y.ticks.color = textColor;
      chart.options.scales.x.grid.color  = gridColor;
      chart.options.scales.y.grid.color  = gridColor;

      if(chart.options.plugins && chart.options.plugins.legend && chart.options.plugins.legend.labels){
        chart.options.plugins.legend.labels.color = textColor;
      }
      if(chart.options.plugins && chart.options.plugins.datalabels){
        chart.options.plugins.datalabels.color = textColor;
      }

      const ds = chart.data.datasets[0];
      ds.borderColor = accent;
      ds.backgroundColor = accent;
      ds.pointBackgroundColor = accent;
      ds.pointBorderColor = "#ffffff";
    }

    function rebuildChartForTeam(t){
      const slug = t.slug;
      const canvas = document.getElementById(`effChart-${slug}`);
      const {weeks,labels,data,abandoned} = getRangeData(t);

      if(t.chart){
        const ds = t.chart.data.datasets[0];
        t.chart.data.labels = labels;
        ds.data = data;
        ds.abandoned = abandoned;
        applyChartTheme(t.chart);
        t.chart.update();
        resetWeekCard(t);
        return;
      }

      t.chart = new Chart(canvas.getContext("2d"),{
        type:"line",
        data:{
          labels,
          datasets:[{
            label:"Efficiency %",
            data,
            tension:0.35,
            fill:false,
            abandoned,
            pointRadius:4,
            pointHoverRadius:6,
            pointHitRadius:14,
            pointBorderWidth:1.5,
            pointStyle:"circle"
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            legend:{display:false},
            tooltip:{
              callbacks:{
                label:(ctx) => {
                  const v = ctx.parsed.y || 0;
                  return `Efficiency: ${v.toFixed(1)}%`;
                }
              }
            },
            datalabels:{
              clamp:true,
              clip:false,
              offset:2,
              align:function(context){
                const v = context.dataset.data[context.dataIndex];
                if(v >= 97) return "bottom";
                if(v <= 73) return "top";
                return "top";
              },
              anchor:"end",
              formatter:(v) => `${v.toFixed(1)}%`,
              font:{size:9,weight:"600"},
              padding:2
            }
          },
          scales:{
            x:{
              title:{display:false}
            },
            y:{
              suggestedMin:70,
              suggestedMax:100,
              ticks:{
                callback:(v) => `${v.toFixed(1)}%`
              }
            }
          },
          onClick:(evt,elements)=>{
            if(!elements.length) return;
            const idx = elements[0].index;
            const wk = weeks[idx];
            if(!wk) return;
            setSelectedWeek(t,wk);
          }
        }
      });

      applyChartTheme(t.chart);
    }

    /******** WEEK CARD ********/
    function resetWeekCard(t){
      const slug = t.slug;
      const front = document.getElementById(`wkFront-${slug}`);
      const back  = document.getElementById(`wkBack-${slug}`);
      const flip  = document.getElementById(`weekFlip-${slug}`);

      front.innerHTML =
        '<div class="empty-state">Tap any point on the chart to view that week‚Äôs efficiency breakdown.</div>';
      back.innerHTML = "";
      flip.classList.remove("flipped");
      t.flipSide = "front";
    }

    function setSelectedWeek(t,wk){
      const slug = t.slug;
      const front = document.getElementById(`wkFront-${slug}`);
      const back  = document.getElementById(`wkBack-${slug}`);
      const flip  = document.getElementById(`weekFlip-${slug}`);

      const effPct = (wk.eff || 0)*100;
      const effStr = `${effPct.toFixed(1)}%`;

      const outcomeClass =
        wk.outcome === "Same" ? "" :
        wk.outcome && wk.outcome.indexOf("Won") !== -1 ? "success" :
        wk.outcome && wk.outcome.indexOf("Lost") !== -1 ? "danger" :
        "warning";

      let benchHtml = "";
      if(wk.bench){
        const parts = wk.bench.split(/\s*,\s*/).filter(Boolean);
        benchHtml = parts.map(p => `<div>${p}</div>`).join("");
      }else{
        benchHtml = "<span class='wk-stat-label'>No upgrade opportunities logged.</span>";
      }

      const cardHtml = `
        <div class="wk-label">Week ${wk.week}</div>
        <div class="wk-title-row">
          <div>
            <div class="wk-team">${t.team}</div>
            <div class="wk-owner">${t.owner}</div>
          </div>
          <div class="wk-eff-pill">
            <span class="wk-stat-label">Efficiency</span>
            <strong>${effStr}</strong>
          </div>
        </div>

        <div class="wk-stat-grid">
          <div class="wk-stat-box">
            <div class="wk-stat-label">Projected Pts</div>
            <div class="wk-stat-val">${wk.proj.toFixed(2)}</div>
          </div>
          <div class="wk-stat-box">
            <div class="wk-stat-label">Actual Pts</div>
            <div class="wk-stat-val">${wk.actual.toFixed(2)}</div>
          </div>
          <div class="wk-stat-box">
            <div class="wk-stat-label">Optimal Pts</div>
            <div class="wk-stat-val">${wk.optimal.toFixed(2)}</div>
          </div>
          <div class="wk-stat-box">
            <div class="wk-stat-label">Benched Pts</div>
            <div class="wk-stat-val">${wk.wasted.toFixed(2)}</div>
          </div>
        </div>

        <div class="wk-bench">
          <div class="wk-bench-title">Optimal Starts</div>
          <div class="wk-bench-body">
            ${benchHtml}
          </div>
        </div>

        <div class="wk-outcomes">
          ${wk.actRes ? `<span class="wk-tag">Actual: ${wk.actRes}</span>` : ""}
          ${wk.optRes ? `<span class="wk-tag">Optimal: ${wk.optRes}</span>` : ""}
          ${wk.outcome ? `<span class="wk-tag ${outcomeClass}">${wk.outcome}</span>` : ""}
        </div>
      `;

      if(t.flipSide === "front"){
        back.innerHTML = cardHtml;
        flip.classList.add("flipped");
        t.flipSide = "back";
      }else{
        front.innerHTML = cardHtml;
        flip.classList.remove("flipped");
        t.flipSide = "front";
      }
    }

    /******** INIT ********/
    applyInitialDarkMode();
    loadData();
  </script>
</body>
</html>
