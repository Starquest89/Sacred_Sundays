<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Owner & Team History ‚Äî Sacred Sundays</title>
<meta name="color-scheme" content="light dark" />
<style>
:root{
  --table-min:1100px;
  --table-max:1500px;
  --bg:#eef2f6;
  --text:#1f2937;
  --muted:#6b7280;
  --card:#fff;
  --border:#d6dbe2;
  --brand:#0f1b2a;
  --band:#203044;
  --accent:#2563eb;
  --shadow:0 2px 5px rgba(0,0,0,.08);
}

/* Dark mode ‚Äî gray / slate look similar to Payouts */
:root.dark{
  --bg:#bdbdbd;      /* page background */
  --text:#e5e7eb;
  --muted:#9ca3af;
  --card:#020617;    /* cards */
  --border:#1f2937;
  --brand:#020617;   /* header/footer */
  --band:#111827;    /* table header band */
  --accent:#60a5fa;
}

html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
}

/* header */
header{
  background:var(--brand);
  color:#fff;
  position:sticky;
  top:0;
  z-index:1000;
  box-shadow:var(--shadow);
}
header .wrap{
  max-width:var(--table-max);
  margin:0 auto;
  padding:14px 12px 18px;
  display:grid;
  grid-template-columns:1fr auto;
  align-items:center;
  gap:12px;
}
header h1{
  margin:0;
  font-size:clamp(22px,2.4vw,32px);
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  letter-spacing:.2px;
}
.pills{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  justify-content:flex-end;
}
.pill{
  box-sizing:border-box;
  display:inline-flex;
  align-items:center;
  gap:8px;
  justify-content:center;
  min-width:144px;
  height:44px;
  padding:10px 16px;
  border-radius:9999px;
  border:2px dashed rgba(255,255,255,.55);
  color:#fff;
  background:transparent;
  font-weight:800;
  line-height:1;
  text-decoration:none;
  cursor:pointer;
  user-select:none;
  transition:background .15s,transform .08s;
}
.pill:hover{ background:rgba(255,255,255,.10); }
.pill:active{ transform:translateY(1px); }
.pill .ico{ font-size:18px; }

/* Filter pill (Active/Inactive toggle) */
.pill-toggle{
  border-style:solid;
  border-color:rgba(255,255,255,.55);
  background:rgba(15,23,42,.4);
}

@media (max-width:900px){
  header .wrap{ grid-template-columns:1fr; }
  .pills{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:10px;
  }
  .pill{
    height:40px;
    min-width:0;
    padding:8px 12px;
    font-size:14px;
  }
  header h1{ font-size:20px; }
}
@media (max-width:430px){
  .pill{
    height:36px;
    padding:6px 10px;
    font-size:13px;
  }
}

/* table (desktop) ‚Äì kept but hidden */
.table-wrap{
  max-width:var(--table-max);
  min-width:var(--table-min);
  margin:14px auto 22px;
  border-radius:12px;
  border:1px solid var(--border);
  background:var(--card);
  overflow:auto;
  box-shadow:var(--shadow);
}
#tbl{
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;
  background:var(--card);
}
#tbl thead th{
  background:var(--band);
  color:#fff;
  font-weight:800;
  text-align:center;
  position:sticky;
  top:0;
  z-index:2;
  padding:.8rem .6rem;
  border-bottom:1px solid var(--border);
  white-space:normal;
  line-height:1.2;
}
#tbl thead th .sort-icon{
  opacity:.8;
  margin-left:6px;
  font-weight:900;
}
#tbl th.sorted-asc .sort-icon::after{ content:" ‚Üë"; }
#tbl th.sorted-desc .sort-icon::after{ content:" ‚Üì"; }
#tbl tbody td{
  padding:.7rem .6rem;
  border-top:1px solid var(--border);
  color:var(--text);
}
#tbl tbody tr:nth-child(even){
  background:rgba(0,0,0,.02);
}
.nowrap{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.center{ text-align:center; }

/* cards (mobile) */
.cards{
  max-width:var(--table-max);
  min-width:0;
  margin:6px auto 28px;
  padding:0 8px;
}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  box-shadow:var(--shadow);
  padding:12px;
  margin-bottom:12px;
}

/* title row: manager + OG badge + status */
.card-head{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
}
.card-head .mgr{
  font-size:18px;
  font-weight:900;
}
.card-head .status{
  margin-left:auto;
}

/* OG badge: star with OG text inside */
.og-badge{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:26px;
  height:26px;
  position:relative;
  margin-left:6px;
}
.og-badge::before{
  content:"";
  position:absolute;
  inset:0;
  background:#facc15;
  mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="black" d="M316.9 17.8L367 150.2 511.3 171.5c26.2 3.8 36.7 36 17.7 54.6l-105 102.3 24.8 144.1c4.5 26.2-23.1 46-46.4 33.7L288 439.6l-129.3 67.6c-23.3 12.2-50.9-7.4-46.4-33.7l24.8-144.1-105-102.3c-19-18.6-8.5-50.8 17.7-54.6L209 150.2 259.1 17.8c10.8-24.5 46.1-24.5 56.9 0z"/></svg>') center/contain no-repeat;
}
.og-badge span{
  position:relative;
  z-index:1;
  font-size:10px;
  font-weight:900;
  color:#000;
}

/* row 2: years + unique names */
.card-meta{
  display:flex;
  align-items:center;
  gap:8px;
  margin-top:4px;
}
.card-meta .league{
  margin-right:auto;
}
.card-meta .unique{
  margin:0 auto;
}

/* chips for meta row + status pill */
.card-head .league,
.card-head .unique,
.card-head .status{
  font-size:11px;
  font-weight:800;
  padding:4px 10px;
  border-radius:999px;
  border:1px dashed var(--border);
}

.status.active{
  background:rgba(52,211,153,.15);
  border-color:rgba(52,211,153,.35);
  color:#34d399;
}
.status.inactive{
  background:rgba(244,114,182,.15);
  border-color:rgba(244,114,182,.35);
  color:#f472b6;
}
.status.unknown{
  background:rgba(156,163,175,.15);
  border-color:rgba(156,163,175,.35);
  color:#9ca3af;
}

/* dotted wrapper for team rows */
.line{
  border-radius:10px;
  border:1px dashed var(--border);
  padding:6px 10px;
  margin-top:8px;
}
.line-row{
  display:flex;
  align-items:center;
  gap:8px;
  padding:4px 0;
}
.cards .team{
  font-size:14px;
  font-weight:800;
  flex:1;
}
.cards .meta{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  justify-content:flex-end;
}
.range-text{
  font-size:13px;
  font-weight:700;
}

/* chip style reused for meta row */
.chip-mini{
  font-size:12px;
  font-weight:800;
  padding:4px 8px;
  border-radius:999px;
  border:1px dashed var(--border);
  color:var(--text);
  background:transparent;
}

/* Footer */
.site-footer{
  background:var(--brand);
  color:#fff;
  box-shadow:var(--shadow);
}
.site-footer .wrap{
  max-width:var(--table-max);
  margin:0 auto;
  padding:12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  font-weight:700;
}
.site-footer .muted{
  opacity:.85;
  font-weight:600;
}

/* Original responsive switch (kept but overridden below) */
@media (max-width:900px){
  body:not(.force-desktop) .table-wrap{ display:none; }
  body:not(.force-desktop) .cards{ display:block; }
}

/* ==== FORCE CARDS-ONLY MODE ==== */
.cards{
  display:block !important;
}
.table-wrap{
  display:none !important;
}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1 class="title"><span aria-hidden="true">üßë‚Äçü§ù‚Äçüßë</span> Owner & Team History</h1>
    <nav class="pills">
      <a class="pill" href="index.html"><span class="ico">üè†</span>Home</a>
      <button id="resetBtn" class="pill" type="button"><span class="ico">üîÑ</span>Reset Page</button>
      <!-- Single toggle button: label shows the OTHER group -->
      <button id="filterBtn" class="pill pill-toggle" type="button">
        <span class="ico">üßë‚Äçü§ù‚Äçüßë</span><span id="filterLbl">Inactive Teams</span>
      </button>
      <button id="themeBtn" class="pill" type="button" aria-pressed="false">
        <span class="ico">üåô</span><span id="themeLbl">Dark Mode</span>
      </button>
    </nav>
  </div>
</header>

<!-- Table markup kept but always hidden by CSS -->
<div class="table-wrap">
  <table id="tbl">
    <thead><tr id="thead-row"></tr></thead>
    <tbody></tbody>
  </table>
</div>

<div class="cards" id="cards"></div>

<script>
// ===== Config =====
const SHEET_ID='1vNjLCTxmM1c09aONXyQYpGTPwcGG-hmnflq8-ZC3Rmo';
const GID='303560786';
const RANGE_REL='B2:K'; // B..K

const COLS=[
  {key:'Status',           label:'Status'},
  {key:'Manager',          label:'Manager'},
  {key:'Team Name',        label:'Team Name'},
  {key:'Time Frame',       label:'Time Frame'},
  {key:'Yrs Name Active',  label:'Yrs Name\nActive',center:true},
  {key:'Unique Team Names',label:'Unique\nTeam Names',center:true},
  {key:'Tot Yrs In League',label:'Tot Yrs\nIn League',center:true},
  {key:'Start',            label:'Start',center:true},
  {key:'Hyphen',           label:'',center:true,optional:true},
  {key:'End',              label:'End',center:true}
];

const COLUMN_WIDTHS={
  1:'92px',
  2:'180px',
  3:'240px',
  4:'160px',
  5:'120px',
  6:'140px',
  7:'120px',
  8:'90px',
  9:'40px',
  10:'90px'
};

// OG owners
const OG_SET = new Set([
  "Ben Cadman",
  "Brad Cumberbatch",
  "Drew McClelland",
  "Todd Bingnear"
]);

// Filter state: which group is CURRENTLY showing
// 'active' | 'inactive'
let currentFilter='active';

// ===== Helpers =====
const $=s=>document.querySelector(s);
const clean=v=>String(v??'').replace(/\u00A0/g,' ').trim();
function escapeHtml(str){
  return String(str??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
}
function pluralize(n,one,many){
  const num=Number(n);
  if(Number.isFinite(num)){
    return num===1 ? one.replace('%',num) : many.replace('%',num);
  }
  return many.replace('%',n||'0');
}
function statusClassFor(txt){
  const lc=(txt||'').trim().toLowerCase();
  if(lc==='active')   return 'active';
  if(lc==='inactive') return 'inactive';
  return 'unknown';
}

// ===== Theme / Reset =====
function updateThemeBtn(){
  const dark=document.body.classList.contains('dark');
  document.documentElement.classList.toggle('dark',dark);
  $('#themeBtn').setAttribute('aria-pressed',dark?'true':'false');
  $('#themeLbl').textContent=dark?'Light Mode':'Dark Mode';
  $('#themeBtn .ico').textContent=dark?'‚òÄÔ∏è':'üåô';
}
(function(){
  if(localStorage.getItem('ss_theme')==='dark') document.body.classList.add('dark');
  updateThemeBtn();
})();
$('#themeBtn').addEventListener('click',()=>{
  const next=!document.body.classList.contains('dark');
  document.body.classList.toggle('dark',next);
  localStorage.setItem('ss_theme',next?'dark':'light');
  updateThemeBtn();
});
$('#resetBtn').addEventListener('click',()=>location.reload());

// ===== Data fetch =====
async function fetchGVizByGid(sheetId,gid,range){
  const url=`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?` +
            new URLSearchParams({gid,range});
  const res=await fetch(url,{cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  const txt=await res.text();
  const json=JSON.parse(txt.substring(txt.indexOf('{'),txt.lastIndexOf('}')+1));
  return json;
}
function parseGViz(json){
  const cols=(json.table.cols||[]).map(c=>(c.label||c.id||'').trim());
  const rows=(json.table.rows||[]).map(r=>(r.c||[]).map(c=>c?(c.f??c.v??''):'')); 
  return {cols,rows};
}
async function fetchCsvByGid(sheetId,gid){
  const url=`https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}&_=${Date.now()}`;
  const res=await fetch(url,{cache:'no-store'});
  if(!res.ok) throw new Error('CSV HTTP '+res.status);
  const text=await res.text();
  const rows=[];
  let cur='',row=[],inQ=false;
  for(let i=0;i<text.length;i++){
    const ch=text[i],nx=text[i+1];
    if(inQ){
      if(ch=='"' && nx=='"'){ cur+='"'; i++; }
      else if(ch=='"'){ inQ=false; }
      else cur+=ch;
    }else{
      if(ch=='"') inQ=true;
      else if(ch==','){ row.push(cur); cur=''; }
      else if(ch=='\n'){ row.push(cur); rows.push(row); row=[]; cur=''; }
      else if(ch!='\r'){ cur+=ch; }
    }
  }
  row.push(cur);
  rows.push(row);
  return rows;
}

// ===== Normalize =====
function normalizeFromGViz(metaCols,dataRows){
  const idx=new Map(metaCols.map((n,i)=>[n,i]));
  return dataRows.map(r=>{
    const o={};
    COLS.forEach((c,ix)=>{
      const i=idx.has(c.key) ? idx.get(c.key) : ix;
      o[c.key]=clean(r[i]);
    });
    return o;
  });
}
function normalizeFromCsv(csvRows){
  const out=[];
  for(let i=1;i<csvRows.length;i++){
    const r=csvRows[i];
    if(!r) continue;
    const o={
      'Status'           : clean(r[1]  ||''),
      'Manager'          : clean(r[2]  ||''),
      'Team Name'        : clean(r[3]  ||''),
      'Time Frame'       : clean(r[4]  ||''),
      'Yrs Name Active'  : clean(r[5]  ||''),
      'Unique Team Names': clean(r[6]  ||''),
      'Tot Yrs In League': clean(r[7]  ||''),
      'Start'            : clean(r[8]  ||''),
      'Hyphen'           : clean(r[9]  ||''),
      'End'              : clean(r[10] ||'')
    };
    if(Object.values(o).every(v=>!v)) continue;
    out.push(o);
  }
  return out;
}

// ===== State + table render (kept but hidden) =====
let ROWS=[];
const HEADERS=COLS.map(c=>c.label);
let sortIdx=1,sortDir='asc';

function sortByIndex(i){
  if(sortIdx===i){
    sortDir=(sortDir==='asc' ? 'desc' : 'asc');
  }else{
    sortIdx=i;
    sortDir='asc';
  }
  const key=COLS[i].key;
  ROWS.sort((a,b)=>{
    const A=a[key]||'', B=b[key]||'';
    const na=Number(A), nb=Number(B);
    if(Number.isFinite(na) && Number.isFinite(nb)){
      return (na-nb) * (sortDir==='asc'?1:-1);
    }
    return String(A).localeCompare(String(B),undefined,{numeric:true,sensitivity:'base'}) *
           (sortDir==='asc'?1:-1);
  });
}

function renderTable(){
  const thead=document.getElementById('thead-row');
  if(!thead) return;
  thead.innerHTML='';
  HEADERS.forEach((h,i)=>{
    const th=document.createElement('th');
    th.className=(COLS[i].center?'center':'');
    th.innerHTML=`<span>${h.replace(/\\n/g,'<br>')}</span> <span class="sort-icon" aria-hidden="true"></span>`;
    th.addEventListener('click',()=>{
      sortByIndex(i);
      document.querySelectorAll('#tbl th').forEach(t=>t.classList.remove('sorted-asc','sorted-desc'));
      th.classList.add(sortDir==='asc'?'sorted-asc':'sorted-desc');
      renderTableBody();
    });
    thead.appendChild(th);
  });

  const table=document.getElementById('tbl');
  if(!table) return;
  table.querySelector('colgroup')?.remove();
  const cg=document.createElement('colgroup');
  for(let i=0;i<HEADERS.length;i++){
    const col=document.createElement('col');
    const w=COLUMN_WIDTHS[i+1];
    if(w) col.style.width=w;
    cg.appendChild(col);
  }
  table.insertBefore(cg,table.firstChild);
  renderTableBody();
}

function renderTableBody(){
  const tbody=document.querySelector('#tbl tbody');
  if(!tbody) return;
  tbody.innerHTML='';
  ROWS.forEach(o=>{
    const tr=document.createElement('tr');
    COLS.forEach(c=>{
      const td=document.createElement('td');
      const v=o[c.key] ?? '';
      if(c.key==='Manager' || c.key==='Team Name') td.classList.add('nowrap');
      if(c.center) td.classList.add('center');
      td.innerHTML=v;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

// ===== Filter label helpers =====
function updateFilterLabel(){
  const lbl = document.getElementById('filterLbl');
  if(!lbl) return;
  // Label shows the OPPOSITE group of what's currently displayed
  lbl.textContent = (currentFilter === 'active') ? 'Inactive Teams' : 'Active Teams';
}

function setFilter(mode){
  currentFilter = mode;
  renderCards();
  updateFilterLabel();
}

// ===== Cards render (mobile ‚Äì always shown) =====
function renderCards(){
  const box=document.getElementById('cards');
  if(!box) return;
  box.innerHTML='';

  // Filter by status first
  const filtered=ROWS.filter(o=>{
    const status=(o['Status']||'').toLowerCase();
    if(currentFilter==='active')   return status==='active';
    if(currentFilter==='inactive') return status!=='active'; // treat blank as inactive
    return true;
  });

  const groups=new Map();
  filtered.forEach(o=>{
    const m=o['Manager'];
    if(!m) return;
    if(!groups.has(m)) groups.set(m,[]);
    groups.get(m).push(o);
  });

  const managers=[...groups.keys()];

  // Order: active first, then inactive; within group -> years desc then name
  managers.sort((a,b)=>{
    const rowsA=groups.get(a);
    const rowsB=groups.get(b);
    const firstA=rowsA[0]||{};
    const firstB=rowsB[0]||{};

    const statusA=(firstA['Status']||'').toLowerCase()==='active'?0:1;
    const statusB=(firstB['Status']||'').toLowerCase()==='active'?0:1;
    if(statusA!==statusB) return statusA-statusB;

    const yrsA=Number(firstA['Tot Yrs In League']||0);
    const yrsB=Number(firstB['Tot Yrs In League']||0);
    if(yrsA!==yrsB) return yrsB-yrsA;

    return a.localeCompare(b);
  });

  managers.forEach(m=>{
    const items=groups.get(m);
    const first=items[0] || {};

    const statusTxt = first['Status'] || '';
    const sClass    = statusClassFor(statusTxt);
    const leagueYrs = first['Tot Yrs In League'] || '';
    const uniqueCnt = first['Unique Team Names'] || '';

    const leagueLabel = pluralize(leagueYrs,'%yr in the league','%yrs in the league');
    const uniqueLabel = pluralize(uniqueCnt,'% unique team name','% unique team names');

    const teamsHtml = items.map(it=>{
      const team  = it['Team Name'] || '';
      const start = it['Start']     || '';
      const mid   = it['Hyphen']    || '-';
      const tf    = it['Time Frame']||'';
      let   end   = it['End']       || '';

      let range='';

      // If end is missing but Time Frame includes "Present", use Time Frame
      if(!end && tf && /present/i.test(tf)){
        range = tf;
      }else if(start || end){
        const midChar = mid || '-';
        range = `${start} ${midChar} ${end}`.trim();
      }else if(tf){
        range = tf;
      }

      return `
        <div class="line-row">
          <div class="team">${escapeHtml(team)}</div>
          <div class="meta">
            ${range ? `<span class="range-text">${escapeHtml(range)}</span>` : ''}
          </div>
        </div>
      `;
    }).join('');

    const card=document.createElement('article');
    card.className='card';
    card.innerHTML=`
      <div class="card-head">
        <span class="mgr">${escapeHtml(m)}</span>
        ${OG_SET.has(m) ? '<span class="og-badge"><span>OG</span></span>' : ''}
        <span class="status ${sClass}">${escapeHtml(String(statusTxt))}</span>
      </div>
      <div class="card-meta">
        <span class="league chip-mini">${escapeHtml(leagueLabel)}</span>
        <span class="unique chip-mini">${escapeHtml(uniqueLabel)}</span>
      </div>
      <div class="line">
        ${teamsHtml}
      </div>
    `;
    box.appendChild(card);
  });
}

// ===== Load =====
async function load(){
  try{
    const j=await fetchGVizByGid(SHEET_ID,GID,RANGE_REL);
    const {cols,rows}=parseGViz(j);
    ROWS=normalizeFromGViz(cols,rows).filter(r=>Object.values(r).some(v=>v));
  }catch(e){
    console.warn('GViz failed, falling back to CSV',e);
    try{
      const csv=await fetchCsvByGid(SHEET_ID,GID);
      ROWS=normalizeFromCsv(csv);
    }catch(err){
      console.error('CSV fallback failed',err);
      ROWS=[];
    }
  }
  sortByIndex(1);
  renderTable();   // built but hidden
  renderCards();   // respect currentFilter (default 'active')
  updateFilterLabel();
}
load();

// Toggle button: switch filter between active/inactive
const filterBtn = document.getElementById('filterBtn');
if(filterBtn){
  filterBtn.addEventListener('click',()=>{
    const next = (currentFilter === 'active') ? 'inactive' : 'active';
    setFilter(next);
  });
}

// quick self-checks
(function(){
  try{
    console.assert(statusClassFor('Inactive')==='inactive','status check');
    console.assert(pluralize(1,'%yr','%yrs')==='1yr','plural 1');
    console.assert(pluralize(2,'%yr','%yrs')==='2yrs','plural 2');
  }catch(e){
    console.warn('Self-checks failed:',e);
  }
})();
</script>

<footer class="site-footer" role="contentinfo">
  <div class="wrap">
    <div>üèà Sacred Sundays ‚Äî <span class="muted">Owner & Team History</span></div>
    <div id="viewCounter" aria-label="Page views">Views: <strong id="viewCountN">0</strong></div>
  </div>
</footer>
<script>
const VIEW_KEY='ss_views_owner_history';
function getViews(){
  const n=Number(localStorage.getItem(VIEW_KEY)||0);
  return Number.isFinite(n)?n:0;
}
function setViews(n){
  try{ localStorage.setItem(VIEW_KEY,String(n)); }catch{}
}
function renderViews(){
  const el=document.getElementById('viewCountN');
  if(el) el.textContent=getViews().toLocaleString();
}
addEventListener('DOMContentLoaded',()=>{
  const n=getViews()+1;
  setViews(n);
  renderViews();
});
</script>
</body>
</html>

